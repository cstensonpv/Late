<!DOCTYPE html>
<meta charset="utf-8">
<head>
<title>Circle shit</title>
</head>
<style>

html, body {
  font: 10px sans-serif;
  width: 100%;
  height: 100%;
  padding: 0;
  margin: 0;
  position: relative;
  font-family: "Century Gothic";
}

h1 {
  font-size: 36px;
}

h2 {
  font-size: 18px;
}

.trainz {
  fill: green;
  stroke: green;
}

#tooltip {
  position: absolute;
  text-align: center;
  opacity: 1;
}

#mouseoverDisp {
  position: absolute;
  opacity: 1;
}

.path--background {
  fill: none;
  stroke: #000;
  stroke-width: 2px;
}

.label {
  font: 24px sans-serif;
  text-anchor: middle;
}
</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://code.jquery.com/jquery-2.0.0.js"></script>
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

<div id="tooltip"><!--
	<p id="title" style="font-size: 40px;">T36 MÃ¤rsta</p>
	<p style="font-size: 20px;">Arrived at:</p>
	<p id="dispArrival" style="font-size: 48px;">- 17:48 -</p>
	<p style="font-size: 18px; color: red;"id="dispDelay">(2 min late)</p>-->
</div>

<p id="mouseoverDisp"></p>

<script>

	
	var solna = [{
  "south": {
    "JourneyDirection": 1,
    "SecondaryDestinationName": "\u00c4lvsj\u00f6",
    "StopAreaName": "Stockholms central",
    "StopAreaNumber": 5011,
    "StopPointNumber": 5013,
    "StopPointDesignation": "S",
    "TimeTabledDateTime": "2016-03-07T20:34:00",
    "ExpectedDateTime": "2016-03-07T20:38:00",
    "DisplayTime": "8 min",
    "Deviations": null,
    "TransportMode": "TRAIN",
    "LineNumber": "35",
    "Destination": "V\u00e4sterhaninge",
    "SiteId": 9000
  },
  "north": {
    "JourneyDirection": 2,
    "SecondaryDestinationName": null,
    "StopAreaName": "Stockholms central",
    "StopAreaNumber": 5011,
    "StopPointNumber": 5014,
    "StopPointDesignation": "N",
    "TimeTabledDateTime": "2016-03-07T00:28:00",
    "ExpectedDateTime": "2016-03-07T00:28:00",
    "DisplayTime": "2 min",
    "Deviations": null,
    "TransportMode": "TRAIN",
    "LineNumber": "35",
    "Destination": "B\u00e5lsta",
    "SiteId": 9000
  }
},
{
	"south": {
    "JourneyDirection": 1,
    "SecondaryDestinationName": "\u00c4lvsj\u00f6",
    "StopAreaName": "Stockholms central",
    "StopAreaNumber": 5011,
    "StopPointNumber": 5013,
    "StopPointDesignation": "S",
    "TimeTabledDateTime": "2016-03-07T19:34:00",
    "ExpectedDateTime": "2016-03-07T19:38:00",
    "DisplayTime": "8 min",
    "Deviations": null,
    "TransportMode": "TRAIN",
    "LineNumber": "35",
    "Destination": "V\u00e4sterhaninge",
    "SiteId": 9000
  }, 
  "north": {
    "JourneyDirection": 2,
    "SecondaryDestinationName": null,
    "StopAreaName": "Stockholms central",
    "StopAreaNumber": 5011,
    "StopPointNumber": 5014,
    "StopPointDesignation": "N",
    "TimeTabledDateTime": "2016-03-07T00:28:00",
    "ExpectedDateTime": "2016-03-07T00:28:00",
    "DisplayTime": "2 min",
    "Deviations": null,
    "TransportMode": "TRAIN",
    "LineNumber": "35",
    "Destination": "B\u00e5lsta",
    "SiteId": 9000
  }},
  {
	"south": {
    "JourneyDirection": 1,
    "SecondaryDestinationName": "\u00c4lvsj\u00f6",
    "StopAreaName": "Stockholms central",
    "StopAreaNumber": 5011,
    "StopPointNumber": 5013,
    "StopPointDesignation": "S",
    "TimeTabledDateTime": "2016-03-07T19:15:00",
    "ExpectedDateTime": "2016-03-07T19:15:00",
    "DisplayTime": "8 min",
    "Deviations": null,
    "TransportMode": "TRAIN",
    "LineNumber": "35",
    "Destination": "V\u00e4sterhaninge",
    "SiteId": 9000
  }, 
  "north": {
    "JourneyDirection": 2,
    "SecondaryDestinationName": null,
    "StopAreaName": "Stockholms central",
    "StopAreaNumber": 5011,
    "StopPointNumber": 5014,
    "StopPointDesignation": "N",
    "TimeTabledDateTime": "2016-03-07T00:28:00",
    "ExpectedDateTime": "2016-03-07T00:28:00",
    "DisplayTime": "2 min",
    "Deviations": null,
    "TransportMode": "TRAIN",
    "LineNumber": "35",
    "Destination": "B\u00e5lsta",
    "SiteId": 9000
  }},
  {
	"south": {
    "JourneyDirection": 1,
    "SecondaryDestinationName": "\u00c4lvsj\u00f6",
    "StopAreaName": "Stockholms central",
    "StopAreaNumber": 5011,
    "StopPointNumber": 5013,
    "StopPointDesignation": "S",
    "TimeTabledDateTime": "2016-03-07T17:58:00",
    "ExpectedDateTime": "2016-03-07T17:59:00",
    "DisplayTime": "8 min",
    "Deviations": null,
    "TransportMode": "TRAIN",
    "LineNumber": "35",
    "Destination": "V\u00e4sterhaninge",
    "SiteId": 9000
  }, 
  "north": {
    "JourneyDirection": 2,
    "SecondaryDestinationName": null,
    "StopAreaName": "Stockholms central",
    "StopAreaNumber": 5011,
    "StopPointNumber": 5014,
    "StopPointDesignation": "N",
    "TimeTabledDateTime": "2016-03-07T00:28:00",
    "ExpectedDateTime": "2016-03-07T00:28:00",
    "DisplayTime": "2 min",
    "Deviations": null,
    "TransportMode": "TRAIN",
    "LineNumber": "35",
    "Destination": "B\u00e5lsta",
    "SiteId": 9000
  }},
  {
	"south": {
    "JourneyDirection": 1,
    "SecondaryDestinationName": "\u00c4lvsj\u00f6",
    "StopAreaName": "Stockholms central",
    "StopAreaNumber": 5011,
    "StopPointNumber": 5013,
    "StopPointDesignation": "S",
    "TimeTabledDateTime": "2016-03-07T16:42:00",
    "ExpectedDateTime": "2016-03-07T16:42:00",
    "DisplayTime": "8 min",
    "Deviations": null,
    "TransportMode": "TRAIN",
    "LineNumber": "35",
    "Destination": "V\u00e4sterhaninge",
    "SiteId": 9000
  }, 
  "north": {
    "JourneyDirection": 2,
    "SecondaryDestinationName": null,
    "StopAreaName": "Stockholms central",
    "StopAreaNumber": 5011,
    "StopPointNumber": 5014,
    "StopPointDesignation": "N",
    "TimeTabledDateTime": "2016-03-07T00:28:00",
    "ExpectedDateTime": "2016-03-07T00:28:00",
    "DisplayTime": "2 min",
    "Deviations": null,
    "TransportMode": "TRAIN",
    "LineNumber": "35",
    "Destination": "B\u00e5lsta",
    "SiteId": 9000
  }
  }]
	var currentStation = 9504;

  	var currentDate = new Date();
  	var currentTime = currentDate.getHours()*60+currentDate.getMinutes();

	function getDelayTime (id) {
    var url = "http://localhost:3000/timetable/until/"+id+"/"+ currentTime; //instead of until you can use between to get between 2 times
    $.ajax({
                 type: "GET",
                 dataType: 'jsonp',
                 cache: false,
                 url: url,
                 success: function (data) {
                    console.log(data)
                    console.log( currentTime)
                    //var delaytime = new Date(data.south.ExpectedDateTime) - new Date(data.south.TimeTabledDateTime)
                    //var expectTime = new Date(data.south.ExpectedDateTime)
                    //var expecTime = (expectTime.getHours()*60*60) + (expectTime.getMinutes()*60) + (expectTime.getSeconds());
                    //var previousTrains = ;
                    //var upcomingTrains = ;
                    var actualTime = (new Date().getHours()*60*60) + (new Date().getHours()*60) + (new Date().getHours());
                    //console.log("expect"+expectTime, "actual"+actualTime)
                    // var expectedSeconds;
                    // console.log(expectedSeconds)
                    //var timeToArrival = new Date(data.south.ExpectedDateTime) - new Date()
                    drawData(data);
                    
                  }
    });
}
  getDelayTime(currentStation);



	var widthPercent = 100;
	var heightPercent = 100;
	
	var width = window.innerWidth * widthPercent/100;
	var height = window.innerHeight * heightPercent/100;
	console.log("w: " + innerWidth + " h: " + innerHeight)

	var svg = d3.select("body")
		.append("svg")
		.attr("width", width)
		.attr("height", height)
		.style("background", "#f0f0f0") 
		
	
	var cx = width/2;
	var cy = height/2;
    var radius = height/Math.PI;
	
	function dateToMins(expected, table){
    var diffMinutes = parseInt(expected.substring(14,16))-parseInt(table.substring(14,16))
    var diffHours = parseInt(expected.substring(11,13))-parseInt(table.substring(11,13))
    var diff = diffHours*60+diffMinutes;
	return diff;
  }

	var circle = svg.append("circle")
		.attr("cx", cx)
		.attr("cy", cy)
		.attr("r", radius)
		.attr("fill", "rgba(50,200,50,0.11)")
		.attr("stroke", "green")
		.attr("stroke-width", "2px")
        .attr("id", "bigCircle")
		
	
     
        
		
	function drawData(data){
				
	var lines = svg.selectAll("g")
			.data(data["south"])
		.enter().append("g").attr("class", "trainz")
			.append("line")
			.attr("x1", cx)
			.attr("x2", cx)
			.attr("y1", (cy - radius))
        	.attr("y2", function(d){
        		return (cy - radius - (dateToMins(d["ExpectedDateTime"], d["TimeTabledDateTime"]))*8); })
        	.style("stroke-width","2px")
        	.attr("transform", function(d) {
						
				hour = parseInt(d["ExpectedDateTime"].substring(11,13));
				minute = parseInt(d["ExpectedDateTime"].substring(14,16));
			   	
        	return "rotate(" + (hour * 60 + minute) / (24 * 60) * 360 + " " + cx + " " + cy + ")"; })
        	
        svg.selectAll("g").append("circle")
        			.attr("class", "blob")
        			.attr("cx", cx)
    				.attr("cy", function(d){
    				return (cy - radius - (dateToMins(d["ExpectedDateTime"], d["TimeTabledDateTime"]))*8)})
    				.attr("r", 5)
    				.attr("transform", function(d){
    						hour = parseInt(d["ExpectedDateTime"].substring(11,13));
							minute = parseInt(d["ExpectedDateTime"].substring(14,16));
							return "rotate(" + (hour * 60 + minute) / (24 * 60) * 360 + " " + cx + " " + cy + ")";})     
        	//.attr("transform", function(d, i) { return "rotate(" + (i * 360 / data.length) + " " + cx + " " + cy + ")"; })
        	//.attr("transform", function(d, i) {return "translate(" + (cy
    
    var trainz = svg.selectAll(".trainz")

    var side = Math.sqrt(Math.pow((radius*2),2)/2);
    var tooltip = d3.select("#tooltip")
        .style("top", cy-side/2 + "px")
        .style("left", cx-side/2  + "px")
        .style("width", side+"px")
        .style("height", side+"px")


    trainz
        .on("mouseover", function(d){
            d3.select("#mouseoverDisp")
                .text(d["ExpectedDateTime"].substring(11,16))
                .style("opacity", "1")
                .style("left", (d3.event.pageX - 75) + "px")     
                .style("top", (d3.event.pageY - 40) + "px")

            // d3.select(this).selectAll(".blob").transition()
//              .duration(300)
//              .attr("cy", function(d){
//                  console.log("bajs")
//                  return (cy - radius - (parseInt(d["south"]["ExpectedDateTime"].substring(14,16))-
//                  parseInt(d["south"]["TimeTabledDateTime"].substring(14,16)))*24)})
        })
        .on("mousemove", function(d){
            d3.select("#mouseoverDisp")
                .style("opacity", 1)
        })
        .on("mouseout", function(d){
            d3.select("#mouseoverDisp").transition()
                .duration(500)
                .style("opacity", 0)
        })
        .on("click", function(d){
            trainz.transition()
                .duration(200)
                .style("fill", "green")
                .style("stroke", "green")

            d3.select(this).transition()
                .duration(200)
                .style("fill", "orange")
                .style("stroke", "orange")

            d3.select("#tooltip")
                .html('<p id="title" style="font-size: '+side/11+'px;">Train to '+d["Destination"]+
                    '</p><p style="font-size: '+side/20+'px;">Arrived at:</p><p id="dispArrival" style="font-size: '+side/8+'px;">'
                    +'- '+d["ExpectedDateTime"].substring(11,16)+' -</p><p style="font-size: '+side/16+'px; color:'
                    +' red;"id="dispDelay">('+dateToMins(d["ExpectedDateTime"], d["TimeTabledDateTime"])+' min late)</p>')
                
            d3.select("#tooltip").transition()
                .duration(250)
                //.style("opacity", "0.5")
            })
           

   }

    

</script>


</body>
</html>

